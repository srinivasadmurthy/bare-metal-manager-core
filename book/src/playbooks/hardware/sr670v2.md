# Lenovo SR670 V2 (7Z23)

## Helpful Links

* [Maintenanace Manual](https://pubs.lenovo.com/sr670-v2/SR670V2_maintenance_manual.pdf)
* [Driver Downloads](https://datacentersupport.lenovo.com/us/en/products/servers/thinksystem/sr670v2/downloads/driver-list)
* [Product Guide](https://lenovopress.lenovo.com/lp1393.pdf)
* [Lenovo Knowledge Transfer](https://drive.google.com/drive/u/1/folders/1iixkyIMrfw5Y6JNFq5yaAMyd7vM84pVD)

## Inventory

Slot map:

| | | |
|---|---|---|
|Slot|Component|Location|
|3|L40|Right most slot, right GPU Tray (SW1)|
|4|L40|Right GPU Tray|
|5|L40|Right GPU Tray|
|6|L40|Right GPU Tray|
|7|L40|Right most slot, left GPU Tray (SW2)|
|8|L40|Left GPU Tray|
|9|L40|Left GPU Tray|
|10|L40|Left GPU Tray|
|15|NVIDIA DPU|Riser 1|
|16|ConnectX Card|Riser 1|
|21|ConnectX Card|Riser 2|
|25|M2 RAID Kit|System Board|
|30|GPU Tray|Right (SW1)|
|31|GPU Tray|Left (SW2)|

Component inventory:

| | | | | | |
|---|---|---|---|---|---|
| Node Type | Vendor | Model | Component | Description | Quantity |
| GPU | Lenovo | ThinkSystem SR670 V2 | GPU | L40 | 8 |
| | | | DPU | Bluefield 2 | 1 |
| | | | Infiniband | ConnectX-7 (100Gb) x 2 port | 2 |
| | | | CPU | Intel Platinum 8362 CPU @ 2.80GHz | 2 |
| | | | Memory | 1TB (64GB Sticks) | 16 |
| | | | Disks (boot) | 960GB M2 NVMe SSD | 2 |
| | | | Disks (data) | 7.68TB EDSFF NVMe SSD | 2 |

## Updating Firmware

Lenovo servers can be finicky about updates so when doing firmware updates follow this advice:

* **Always update XCC before UEFI.** You can go from any version to the latest in one go.
* **Always update UEFI while the system is powered off**
* If updating from an old version due to MB replacement:
  * If below 1.51, update to 1.51 first
  * Then update to 2.10. This isn't technically required as far as the documentation is concerned,
  but Lenovo seems to think that it can cause DXE INIT issues if you go directly from 1.51 to 3.xx,
  so we do this extra step. You will need to boot the system so it can apply the firmware before proceeding to
  3.xx versions.
  * Then update to current site build version, which is 2.60 currently
* Lenovo recommends using XCC to apply firmware updates, but [OneCLI](./onecli.md) can also be used.

### Firmware Downloads

| | |
|---|---|
| XCC 4.14 | lnvgy\_fw\_xcc\_tgbt52f-4.14\_anyos\_noarch.uxz |
| | [https://datacentersupport.lenovo.com/tw/en/downloads/DS571801](https://datacentersupport.lenovo.com/tw/en/downloads/DS571801) |
| UEFI 2.60 | lnvgy\_fw\_uefi\_u8e128n-2.60\_anyos\_32-64.uxz |
| | [https://datacentersupport.lenovo.com/tw/en/downloads/DS572282](https://datacentersupport.lenovo.com/tw/en/downloads/DS572282) |
| UEFI 1.51 (prereq for 2.xx) | lnvgy\_fw\_uefi\_u8e122j-1.51\_anyos\_32-64.uxz |
| |  [https://datacentersupport.lenovo.com/us/en/downloads/DS562960](https://datacentersupport.lenovo.com/us/en/downloads/DS562960) |

## Internal Cabling

By far, the largest issue with the SR670 V2 has to do with issues related to internal cabling.
Due to the flexible nature of the server there are MANY ways to cable the GPUs and risers in the system.

Symptoms of incorrect cabling can include:

* System hang at DXE INIT
* Missing PCIe devices
* PCIe Conn X has encountered a configuration error

The following graphic shows how the data cables should route in the system.

<figure>
<img src=../../static/playbooks/hardware/sr670v2_config35_cabling.png
alt="SR670 V2 MCIO cable routing">
</figure>

More details can be found in the maintenance manual. The SR 670 V2 configuration we use is the
"**8-DW GPU Model cable routing; Configuration J**" variety which is found starting on page 121 of the
maintenance manual. **I would highly recommend that when dealing with issues that may be related to cabling,
that you provide both the graphic showing the high level system connectivity as well as a link to the maintenance
manual stating they should carefully validate the cabling as shown on pages 121 - 126 for the drive backplane,
GPU distribution boards, rear riser and onboard Ethernet components.**

### Backplane

<figure>
<img src=../../static/playbooks/hardware/sr670v2_drive_backplane_cabling.png
alt="SR670 V2 drive backplane cable routing">
</figure>

### GPU Distribution Board

<figure>
<img src=../../static/playbooks/hardware/sr670v2_gpu_cabling_1.png
alt="SR670 V2 MCIO GPU cable routing">
</figure>
<figure>
<img src=../../static/playbooks/hardware/sr670v2_gpu_cabling_2.png
alt="SR670 V2 MCIO GPU cable routing">
</figure>

### Rear Riser

<figure>
<img src=../../static/playbooks/hardware/sr670v2_riser_cabling.png
alt="SR670 V2 PCIe riser cable routing">
</figure>

### OCP Ethernet Adapter

<figure>
<img src=../../static/playbooks/hardware/sr670v2_ocp_cable.png
alt="SR670 V2 OCP ethernet cable routing">
</figure>
