syntax = "proto3";

package mlx_device;

import "common.proto";
import "google/protobuf/timestamp.proto";

// MlxVariableRegistry represents a registry of mlxconfig variables
// with optional device filtering constraints.
message MlxVariableRegistry {
  // name is the registry name.
  string name = 1;

  // variables contains all the variables defined in this registry.
  repeated MlxConfigVariable variables = 2;

  // filters contains optional device filtering constraints.
  // If not set, the registry applies to all devices.
  optional DeviceFilterSet filters = 3;
}

// MlxVariableSpec represents the specification for a variable type.
message MlxVariableSpec {
  oneof spec_type {
    BooleanSpec boolean = 1;
    IntegerSpec integer = 2;
    StringSpec string = 3;
    BinarySpec binary = 4;
    BytesSpec bytes = 5;
    ArraySpec array = 6;
    EnumSpec enum_type = 7;
    PresetSpec preset = 8;
    BooleanArraySpec boolean_array = 9;
    IntegerArraySpec integer_array = 10;
    EnumArraySpec enum_array = 11;
    BinaryArraySpec binary_array = 12;
    OpaqueSpec opaque = 13;
  }

  message BooleanSpec {
  }

  message IntegerSpec {
  }

  message StringSpec {
  }

  message BinarySpec {
  }

  message BytesSpec {
  }

  message ArraySpec {
  }

  message OpaqueSpec {
  }

  message EnumSpec {
    repeated string options = 1;
  }

  message PresetSpec {
    uint32 max_preset = 1;
  }

  message BooleanArraySpec {
    uint64 size = 1;
  }

  message IntegerArraySpec {
    uint64 size = 1;
  }

  message EnumArraySpec {
    repeated string options = 1;
    uint64 size = 2;
  }

  message BinaryArraySpec {
    uint64 size = 1;
  }
}

// MlxConfigVariable represents a variable definition.
message MlxConfigVariable {
  string name = 1;
  string description = 2;
  bool read_only = 3;
  MlxVariableSpec spec = 4;
}

// MlxValueType represents a typed value.
message MlxValueType {
  oneof value_type {
    bool boolean = 1;
    int64 integer = 2;
    string string_val = 3;
    bytes binary = 4;
    bytes bytes_val = 5;
    StringArray array = 6;
    string enum_val = 7;
    uint32 preset = 8;
    BooleanArray boolean_array = 9;
    IntegerArray integer_array = 10;
    StringArray enum_array = 11;
    BytesArray binary_array = 12;
    bytes opaque = 13;
  }

  message StringArray {
    repeated string values = 1;
  }

  message BooleanArray {
    repeated OptionalBool values = 1;
  }

  message IntegerArray {
    repeated OptionalInt64 values = 1;
  }

  message BytesArray {
    repeated OptionalBytes values = 1;
  }

  message OptionalBool {
    bool has_value = 1;
    bool value = 2;
  }

  message OptionalInt64 {
    bool has_value = 1;
    int64 value = 2;
  }

  message OptionalString {
    bool has_value = 1;
    string value = 2;
  }

  message OptionalBytes {
    bool has_value = 1;
    bytes value = 2;
  }
}

// MlxConfigValue represents a complete typed value with its variable definition.
message MlxConfigValue {
  MlxConfigVariable variable = 1;
  MlxValueType value = 2;
}

// QueriedDeviceInfo represents device information from a query.
message QueriedDeviceInfo {
  optional string device_id = 1;
  optional string device_type = 2;
  optional string part_number = 3;
  optional string description = 4;
}

// QueriedVariable represents a complete queried variable with all its states.
message QueriedVariable {
  MlxConfigVariable variable = 1;
  MlxConfigValue current_value = 2;
  MlxConfigValue default_value = 3;
  MlxConfigValue next_value = 4;
  bool modified = 5;
  bool read_only = 6;
}

// QueryResult represents the complete query response.
message QueryResult {
  QueriedDeviceInfo device_info = 1;
  repeated QueriedVariable variables = 2;
}

// PlannedChange represents a planned change before execution.
message PlannedChange {
  string variable_name = 1;
  MlxConfigValue current_value = 2;
  MlxConfigValue desired_value = 3;
}

// VariableChange represents a change that was applied.
message VariableChange {
  string variable_name = 1;
  MlxConfigValue old_value = 2;
  MlxConfigValue new_value = 3;
}

// ComparisonResult represents the result of a comparison operation.
message ComparisonResult {
  uint64 variables_checked = 1;
  uint64 variables_needing_change = 2;
  repeated PlannedChange planned_changes = 3;
  QueryResult query_result = 4;
}

// SyncResult represents the result of a sync operation.
message SyncResult {
  uint64 variables_checked = 1;
  uint64 variables_changed = 2;
  repeated VariableChange changes_applied = 3;
  QueryResult query_result = 4;
}

// MlxDeviceReport represents a complete device discovery report
// with metadata and filtered device results.
message MlxDeviceReport {
  // hostname is the system hostname where the report was generated.
  string hostname = 1;
  // timestamp is when the report was generated.
  google.protobuf.Timestamp timestamp = 2;
  // devices contains the discovered devices matching any applied filters.
  repeated MlxDeviceInfo devices = 3;
  // filters contains the filter set used to generate this report.
  optional DeviceFilterSet filters = 4;

  common.MachineId machine_id = 5;
}

// MlxDeviceInfo represents detailed information about a Mellanox network device.
message MlxDeviceInfo {
  // pci_name is the PCI address or MST device path for the device.
  string pci_name = 1;
  // device_type identifies the specific Mellanox device model.
  string device_type = 2;
  // psid (Parameter-Set IDentification) is a 16-ASCII character string
  // embedded in the firmware image which provides a unique identification
  // for the configuration.
  string psid = 3;
  // device_description provides a human-readable description of the device.
  string device_description = 4;
  // part_number is the manufacturer part number for the device.
  string part_number = 5;
  // fw_version_current is the currently installed firmware version.
  string fw_version_current = 6;
  // pxe_version_current is the currently installed PXE boot version.
  string pxe_version_current = 7;
  // uefi_version_current is the currently installed UEFI boot version.
  string uefi_version_current = 8;
  // uefi_version_virtio_blk_current is the currently installed UEFI
  // VirtIO block driver version.
  string uefi_version_virtio_blk_current = 9;
  // uefi_version_virtio_net_current is the currently installed UEFI
  // VirtIO network driver version.
  string uefi_version_virtio_net_current = 10;
  // base_mac is the base MAC address for the device as a string.
  string base_mac = 11;
  // status is the status string returned by mlxfwmanager.
  string status = 12;
}

// DeviceFilterSet represents a collection of filters that must all match.
message DeviceFilterSet {
  // filters contains the list of individual filters to apply.
  repeated DeviceFilter filters = 1;
}

// DeviceFilter represents a single filter criterion for device matching.
message DeviceFilter {
  // field specifies which device field to match against.
  DeviceField field = 1;
  // values contains the list of acceptable values for this field.
  repeated string values = 2;
  // match_mode defines how values should be matched against the device field.
  MatchMode match_mode = 3;
}

// DeviceField represents the available device fields for filtering.
enum DeviceField {
  DEVICE_FIELD_UNSPECIFIED = 0;
  DEVICE_FIELD_DEVICE_TYPE = 1;
  DEVICE_FIELD_PART_NUMBER = 2;
  DEVICE_FIELD_FIRMWARE_VERSION = 3;
  DEVICE_FIELD_MAC_ADDRESS = 4;
  DEVICE_FIELD_DESCRIPTION = 5;
  DEVICE_FIELD_PCI_NAME = 6;
  DEVICE_FIELD_STATUS = 7;
}

// MatchMode defines how filter values should be matched against
// device fields.
enum MatchMode {
  MATCH_MODE_UNSPECIFIED = 0;
  MATCH_MODE_REGEX = 1;
  MATCH_MODE_EXACT = 2;
  MATCH_MODE_PREFIX = 3;
}

// ProfileTargetConstraints defines criteria for matching devices
// to configuration profiles.
message ProfileTargetConstraints {
  // device_types contains allowed device type prefixes for matching.
  repeated string device_types = 1;
  // part_numbers contains allowed part number prefixes for matching.
  repeated string part_numbers = 2;
  // fw_versions contains allowed firmware version prefixes for matching.
  repeated string fw_versions = 3;
}


// PublishMlxDeviceReportRequest is sent by scout or the agent
// into carbide-api so that we can both observe the current
// state of the Mellanox devices (DPAs and DPUs), and potentially
// decide to take action on them (instruct scout to update
// firmware, configuration, etc).
message PublishMlxDeviceReportRequest {
  MlxDeviceReport report = 1;
}

// PublishMlxDeviceReportResponse is returned by carbide-api
// in response to a PublishMlxDeviceReportRequest. It currently
// is actually just a placeholder response, but there's a good
// chance it will soon contain actions to take based on the
// observations made in the parent request.
message PublishMlxDeviceReportResponse {
}

// SerializableMlxConfigProfile is a protobuf representation
// of an mlxconfig-profile SerializableProfile, which itself
// is a serializable representation of an MlxConfigProfile.
// This is used for sending down a profile configuration from
// the API to scout (or the agent) for applying mlxconfig
// based configuration to a device. The profile itself can
// be defined as TOML in the carbide-api config, or it
// can be stored in the database. The profiles themselves
// are ultimately deserialized to MlxConfigProfile instances
// within their respective components, but we then convert
// to a SerializableProfile before serializing to/from
// a TOML/YAML/JSON/protobuf format.
message SerializableMlxConfigProfile {
  // name is the profile name.
  string name = 1;

  // registry_name is the mlx variable configuration
  // registry that this profile is backed by. The registry
  // is where variable types are assigned, as well as
  // any device filters for what device types are allowed
  // to be used.
  string registry_name = 2;

  // description is an optional description for the profile.
  // It should probably generally be set, but whatever I made
  // it optional.
  optional string description = 3;

  // config is a map of variable -> value, where, in this case,
  // the value is actually a YAML string representation of
  // the underlying value (which is how we're serializing it
  // out to send it over the wire). If for some reason someone
  // tries fuddling with direct proto values, then it will
  // just fail to deserialize to a SerializableProfile on
  // the other side (since we attempt to deserialize to the
  // underlying variable-typed value). I could have also done
  // something fancy with a map<string, special-oneof-type> to
  // be able to [de]serialize with typed values, but it seemed
  // like a lot of extra work for something that is pretty well
  // wrapped and bounded by typing already.
  map<string, string> config = 4;
}

// FirmwareCredentials represents authentication credentials for
// accessing firmware or device config resources. Maps to the Rust
// Credentials enum in libmlx::firmware::credentials.
message FirmwareCredentials {
  oneof credential_type {
    BearerTokenCredentials bearer_token = 1;
    BasicAuthCredentials basic_auth = 2;
    HeaderCredentials header = 3;
    SshKeyCredentials ssh_key = 4;
    SshAgentCredentials ssh_agent = 5;
  }
}

// BearerTokenCredentials uses an Authorization: Bearer <token> header.
message BearerTokenCredentials {
  string token = 1;
}

// BasicAuthCredentials uses HTTP Basic authentication.
message BasicAuthCredentials {
  string username = 1;
  string password = 2;
}

// HeaderCredentials uses a custom HTTP header for authentication.
message HeaderCredentials {
  string name = 1;
  string value = 2;
}

// SshKeyCredentials uses a private key file for SSH authentication.
message SshKeyCredentials {
  string path = 1;
  optional string passphrase = 2;
}

// SshAgentCredentials uses the running SSH agent for authentication.
message SshAgentCredentials {
}

// FirmwareSpec identifies a firmware target by device identity
// (part_number, psid) and the target firmware version. It is
// used to construct a FirmwareFlasher following an RAII model,
// where we poll the device to confirm part_number + PSID of
// the device match that of the spec, otherwise we won't hand
// back a new flasher. This helps to ensure we will only flash
// firmware to a device the firmware supports.
message FirmwareSpec {
  // part_number is the manufacturer part number for the target device
  // (e.g., "900-9D3B4-00CV-TA0").
  string part_number = 1;
  // psid (Parameter-Set IDentification) identifies the firmware
  // configuration of the target device (e.g., "MT_0000000884").
  string psid = 2;
  // version is the target firmware version string (e.g., "32.43.1014").
  string version = 3;
}

// FlashSpec specifies the source locations and caching options for
// flash and verify_image operations. Passed to flasher.flash() and
// flasher.verify_image().
message FlashSpec {
  // firmware_url is the location of the firmware binary.
  // Supports local paths, file://, https://, and ssh:// URLs.
  string firmware_url = 1;
  // firmware_credentials is the optional authentication for
  // downloading the firmware binary.
  optional FirmwareCredentials firmware_credentials = 2;
  // device_conf_url is the optional location of the device config
  // to apply before flashing (e.g., a debug token or mlxconfig blob).
  optional string device_conf_url = 3;
  // device_conf_credentials is the optional authentication for
  // downloading the device config.
  optional FirmwareCredentials device_conf_credentials = 4;
  // verify_from_cache controls whether verify_image() uses the
  // cached firmware from cache_dir instead of re-pulling from source.
  bool verify_from_cache = 5;
  // cache_dir is the directory for staging downloaded firmware files.
  // Defaults to a temporary directory if not specified.
  optional string cache_dir = 6;
}

// FlashOptions contains lifecycle flags for the apply() orchestrator.
// Controls which post-flash steps are executed.
message FlashOptions {
  // verify_image controls whether the firmware image on the device is
  // verified against the source binary after flashing. Default is false.
  bool verify_image = 1;
  // verify_version controls whether the firmware version on the device
  // is checked after flashing. Default is false.
  bool verify_version = 2;
  // reset controls whether the device is reset via mlxfwreset after
  // flashing. Default is false.
  bool reset = 3;
  // reset_level is the mlxfwreset level to use. Default is 3.
  uint32 reset_level = 4;
}

// FirmwareFlasherProfile bundles a FirmwareSpec, FlashSpec, and
// FlashOptions into a complete firmware management profile. Used by
// the API runtime config and sent to scout via OpCode::ApplyFirmware.
message FirmwareFlasherProfile {
  FirmwareSpec firmware_spec = 1;
  FlashSpec flash_spec = 2;
  optional FlashOptions flash_options = 3;
}

message MlxObservationReport {
  common.MachineId machine_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  repeated MlxObservation observations = 3;
}

// FirmwareFlashReport captures the outcome of each step in the
// firmware flash lifecycle: flash, reset, image verification, and
// version verification. Each optional step (reset, verify_image,
// verify_version) is controlled by the corresponding flag in
// SupernicFirmwareConfig. A None value means the step was not
// requested; Some(true/false) means it was attempted and the result.
// Sent from scout to the API as part of an MlxObservation after an
// ApplyFirmware operation.
message FirmwareFlashReport {
  // Whether the firmware was successfully flashed via flint.
  bool flashed = 1;
  // Whether the device was successfully reset via mlxfwreset.
  // None if config.reset was false (not requested).
  optional bool reset = 2;
  // Whether the firmware image on the device was verified against
  // the source image via flint verify.
  // None if config.verify_image was false (not requested).
  optional bool verified_image = 3;
  // Whether the firmware version on the device matches the expected
  // version. None if config.verify_version was false (not requested).
  optional bool verified_version = 4;
  // The firmware version observed on the device after flashing,
  // queried via mlxfwmanager. None if the device could not be queried
  // or if the step was not performed.
  optional string observed_version = 5;
  // The expected firmware version from the config, if one was set.
  optional string expected_version = 6;
}

message MlxObservation {
  MlxDeviceInfo device_info = 1;
  optional LockStatus lock_status = 2;
  optional string profile_name = 3;
  optional bool profile_synced = 4;
  // firmware_report captures the outcome of the firmware flash lifecycle
  // during the ApplyFirmware state. Each step's report reflects whether
  // it was requested (via config flags) and whether it succeeded.
  optional FirmwareFlashReport firmware_report = 5;
}

// PublishMlxObservationReportRequest is sent by scout or the agent
// into carbide-api so that we can both observe the current
// state of the Mellanox devices (DPAs and DPUs), and potentially
// decide to take action on them (instruct scout to update
// firmware, configuration, etc).
message PublishMlxObservationReportRequest {
  MlxObservationReport report = 1;
}

// PublishMlxObservationReportResponse is returned by carbide-api
// in response to a PublishMlxDeviceReportRequest. It currently
// is actually just a placeholder response, but there's a good
// chance it will soon contain actions to take based on the
// observations made in the parent request.
message PublishMlxObservationReportResponse {
}

// MlxAdminProfileSyncRequest is sent by an administrative
// caller to sync a given profile (as loaded into carbide-api)
// to the target machine and device, via an active ScoutStream
// connection.
message MlxAdminProfileSyncRequest {
  // machine_id is the target machine ID.
  common.MachineId machine_id = 1;
  // device_id is the PCI address or mst path of
  // the target device to work with on the target machine.
  string device_id = 2;
  // profile_name is the name of the profile, which is loaded
  // into carbide-api, to sync to the target machine device.
  string profile_name = 3;
}

// ProfileSyncCliResponse is the response to a profile sync CLI request.
message MlxAdminProfileSyncResponse {
  SyncResult sync_result = 1;
}

// MlxDeviceProfileSyncRequest is sent by carbide-api internally to
// the agent to sync a profile to the device.
message MlxDeviceProfileSyncRequest {
  // device_id is the target device path, which can be either
  // a PCI address, or a /dev/mst path, depending on how the
  // host is reporting its devices (either works).
  string device_id = 1;
  // profile_name is the name of the profile being applied,
  // which is also contained within profile_data.
  string profile_name = 2;
  // serializable_profile is the SerializableProfile variant of
  // the MlxConfigProfile being sent. The main difference is that
  // it doesn't also included the embedded MlxConfigRegistry
  // serialized data also. It's the simple format.
  SerializableMlxConfigProfile serializable_profile = 3;
}

// MlxDeviceProfileSyncResponse is sent by the scout agent back to
// carbide-api in response to processing an MlxDeviceProfileSyncRequest.
message MlxDeviceProfileSyncResponse {
  oneof reply {
    SyncResult sync_result = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminProfileCompareRequest is sent by the CLI to compare a profile.
message MlxAdminProfileCompareRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
  string profile_name = 3;
}

// MlxAdminProfileCompareResponse is the response to a profile compare CLI request.
message MlxAdminProfileCompareResponse {
  ComparisonResult comparison_result = 1;
}

// MlxDeviceProfileCompareRequest is sent to scout to compare a profile against a device.
message MlxDeviceProfileCompareRequest {
  string device_id = 1;
  string profile_name = 2;
  SerializableMlxConfigProfile serializable_profile = 3;
}

// MlxDeviceProfileCompareResponse is sent by the agent in response to ProfileCompareRequest.
message MlxDeviceProfileCompareResponse {
  oneof reply {
    ComparisonResult comparison_result = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminLockdownLockRequest is the administrative message sent to
// carbide-api requesting a machine lock down a given device.
message MlxAdminLockdownLockRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
}

// MlxAdminLockdownLockResponse is the response from carbide-api back
// to an administrative caller about the result of an internal attempt
// to lock down a device on a given machine.
message MlxAdminLockdownLockResponse {
  StatusReport status_report = 1;
}

// MlxAdminLockdownUnlockRequest is the administrative message sent to
// carbide-api requesting a machine unlock a given device.
message MlxAdminLockdownUnlockRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
}

// MlxAdminLockdownUnlockResponse is the response from carbide-api back
// to an administrative caller about the result of an internal attempt
// to unlock a device on a given machine.
message MlxAdminLockdownUnlockResponse {
  StatusReport status_report = 1;
}

// MlxAdminLockdownStatusRequest is the administrative message sent to
// carbide-api requesting a machine lock status for a given device.
message MlxAdminLockdownStatusRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
}

// MlxAdminLockdownStatusResponse is the response from carbide-api back
// to an administrative caller about the result of an internal attempt
// to get the lock status of a device on a given machine.
message MlxAdminLockdownStatusResponse {
  StatusReport status_report = 1;
}

// MlxDeviceLockdownLockRequest is sent internally by carbide-api to
// the scout agent to lock a device on the target machine.
message MlxDeviceLockdownLockRequest {
  // device_id is the target device path, which can be either
  // a PCI address, or a /dev/mst path, depending on how the
  // host is reporting its devices (either works).
  string device_id = 1;
  // key is the key to use to lock the device.
  string key = 2;
}

// MlxDeviceLockdownUnlockRequest is sent internally by carbide-api to
// the scout agent to unlock a device on the target machine.
message MlxDeviceLockdownUnlockRequest {
  // device_id is the target device path, which can be either
  // a PCI address, or a /dev/mst path, depending on how the
  // host is reporting its devices (either works).
  string device_id = 1;
  // key is the key to use to unlock the device.
  string key = 2;
}

// MlxDeviceLockdownStatusRequest is sent internally by carbide-api to
// the scout agent to get the lock status of a device on the target machine.
message MlxDeviceLockdownStatusRequest {
  // device_id is the target device path, which can be either
  // a PCI address, or a /dev/mst path, depending on how the
  // host is reporting its devices (either works).
  string device_id = 1;
}

// MlxDeviceLockdownResponse is sent by the scout agent back to carbide-api
// in response to any lockdown requests. It's generic enough that it seemso
// to work for now.
message MlxDeviceLockdownResponse {
  oneof reply {
    StatusReport status_report = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxDeviceInfoDeviceRequest is an internal message sent from carbide-api
// to the scout agent to get an MlxDeviceInfo update for the given device.
message MlxDeviceInfoDeviceRequest {
  // device_id is the target device path, which can be either
  // a PCI address, or a /dev/mst path, depending on how the
  // host is reporting its devices (either works).
  string device_id = 1;
}

// MlxDeviceInfoDeviceResponse is a reply sent from scout back to
// carbide-api with the MlxDeviceInfo data for the device.
message MlxDeviceInfoDeviceResponse {
  oneof reply {
    MlxDeviceInfo device_info = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxDeviceInfoReportRequest is an internal message sent from carbide-api
// to the scout agent to get an MlxDeviceReport update containing all devices
// for the given machine.
message MlxDeviceInfoReportRequest {
  optional DeviceFilterSet filters = 1;
}

// MlxDeviceInfoReportResponse is a reply sent from scout back to
// carbide-api with the MlxDeviceReport of all devices on the machine.
message MlxDeviceInfoReportResponse {
  oneof reply {
    MlxDeviceReport device_report = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminRegistryListRequest is sent by the CLI to list registries.
message MlxAdminRegistryListRequest {
  common.MachineId machine_id = 1;
}

// MlxAdminRegistryListResponse is the response with registry list.
message MlxAdminRegistryListResponse {
  RegistryListing registry_listing = 1;
}

// MlxDeviceRegistryListRequest is sent internally from carbide-api to
// the scout agent to request its MlxVariableRegistry information.
message MlxDeviceRegistryListRequest {
}

// MlxDeviceRegistryListResponse is sent by scout back to carbide-api
// with the names of the MlxVariableRegistry entries it knows about.
message MlxDeviceRegistryListResponse {
  oneof reply {
    RegistryListing registry_listing = 1;
    MlxDeviceStreamError error = 2;
  }
}

message RegistryListing {
  repeated string registry_names = 1;
}

// MlxAdminRegistryShowRequest is sent by the CLI to show a registry.
message MlxAdminRegistryShowRequest {
  common.MachineId machine_id = 1;
  string registry_name = 2;
}

// MlxAdminRegistryShowResponse is the response with registry data.
message MlxAdminRegistryShowResponse {
  MlxVariableRegistry variable_registry = 1;
}

// MlxDeviceRegistryShowRequest is sent by carbide-api to scout to
// get the complete MlxVariableRegistry as known by scout on the host.
message MlxDeviceRegistryShowRequest {
  string registry_name = 1;
}

// MlxDeviceRegistryShowResponse is sent by the agent back to carbide-api
// with the serialized registry data.
message MlxDeviceRegistryShowResponse {
  oneof reply {
    MlxVariableRegistry variable_registry = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminConfigSyncRequest is sent by the CLI for sync operations.
message MlxAdminConfigSyncRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
  string registry_name = 3;
  repeated VariableAssignment assignments = 4;
}

// MlxAdminConfigSyncResponse is the response with sync results.
message MlxAdminConfigSyncResponse {
  SyncResult sync_result = 1;
}

// MlxDeviceConfigSyncRequest is sent to the agent to sync device variables.
message MlxDeviceConfigSyncRequest {
  string device_id = 1;
  string registry_name = 2;
  repeated VariableAssignment assignments = 3;
}

// MlxDeviceConfigSyncResponse is sent by the agent with sync results.
message MlxDeviceConfigSyncResponse {
  oneof reply {
    SyncResult sync_result = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminConfigQueryRequest is sent by the CLI for query operations.
message MlxAdminConfigQueryRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
  string registry_name = 3;
  // note: if empty list, query all variables
  repeated string variables = 4;
}

// MlxAdminConfigQueryResponse is the response with query results.
message MlxAdminConfigQueryResponse {
  QueryResult query_result = 1;
}

// MlxDeviceConfigQueryRequest is sent to the agent to query device variables.
message MlxDeviceConfigQueryRequest {
  string device_id = 1;
  string registry_name = 2;
  // note: if empty list, query all variables
  repeated string variables = 3;
}

// MlxDeviceConfigQueryResponse is sent by the agent with query results.
message MlxDeviceConfigQueryResponse {
  oneof reply {
    QueryResult query_result = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminConfigSetRequest is sent by the CLI for set operations.
message MlxAdminConfigSetRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
  string registry_name = 3;
  repeated VariableAssignment assignments = 4;
}

// MlxAdminConfigSetResponse is the response after setting variables.
message MlxAdminConfigSetResponse {
  uint32 total_applied = 1;
}

// MlxDeviceConfigSetRequest is sent to the agent to set device variables.
message MlxDeviceConfigSetRequest {
  string device_id = 1;
  string registry_name = 2;
  repeated VariableAssignment assignments = 3;
}

// MlxDeviceConfigSetResponse is sent by the agent after setting variables.
message MlxDeviceConfigSetResponse {
  oneof reply {
    uint32 total_applied = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminConfigCompareRequest is sent by the CLI for compare operations.
message MlxAdminConfigCompareRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
  string registry_name = 3;
  repeated VariableAssignment assignments = 4;
}

// MlxAdminConfigCompareResponse is the response with comparison results.
message MlxAdminConfigCompareResponse {
  ComparisonResult comparison_result = 1;
}

// MlxDeviceConfigCompareRequest is sent to the agent to compare device variables.
message MlxDeviceConfigCompareRequest {
  string device_id = 1;
  string registry_name = 2;
  repeated VariableAssignment assignments = 3;
}

// MlxDeviceConfigCompareResponse is sent by the agent with comparison results.
message MlxDeviceConfigCompareResponse {
  oneof reply {
    ComparisonResult comparison_result = 1;
    MlxDeviceStreamError error = 2;
  }
}

// MlxAdminProfileShowRequest is sent by the CLI to show a specific profile
// loaded into carbide-api. Note that this is only between the CLI and API,
// there's no ScoutStream integration with this, since the profile is something
// that is specifically configured within carbide-api.
message MlxAdminProfileShowRequest {
  string profile_name = 1;
}

// MlxAdminProfileShowResponse is the response with profile details.
// Note that this is only between the CLI and API,
// there's no ScoutStream integration with this, since the profile is something
// that is specifically configured within carbide-api.
message MlxAdminProfileShowResponse {
  SerializableMlxConfigProfile serializable_profile = 1;
}

// MlxAdminProfileListRequest is sent by the CLI to list all profiles.
message MlxAdminProfileListRequest {
}

// MlxAdminProfileListResponse is the response with a list of profiles.
message MlxAdminProfileListResponse {
  repeated ProfileSummary profiles = 1;
}

// MlxAdminDeviceInfoRequest is sent by the CLI for single device info operations.
message MlxAdminDeviceInfoRequest {
  common.MachineId machine_id = 1;
  string device_id = 2;
}

// MlxAdminDeviceInfoResponse is the response to a device info request.
message MlxAdminDeviceInfoResponse {
  MlxDeviceInfo device_info = 1;
}

// MlxAdminDeviceReportRequest is sent by the CLI for full (all) device report operations.
message MlxAdminDeviceReportRequest {
  common.MachineId machine_id = 1;
}

// MlxAdminDeviceReportResponse is the response to a device report request.
message MlxAdminDeviceReportResponse {
  MlxDeviceReport device_report = 1;
}

// ProfileSummary contains summary information about a profile.
message ProfileSummary {
  string name = 1;
  optional string description = 2;
  string registry_name = 3;
  uint32 variable_count = 4;
}

// VariableAssignment represents a variable name and value assignment.
message VariableAssignment {
  string variable_name = 1;
  // value is a string representation that will be parsed
  // to an actual value type based on variable type.
  string value = 2;
}

// MlxDeviceStreamError is a mechanism to send an error back over the stream,
// since you can't send status errors over established bidirectional
// streams.
message MlxDeviceStreamError {
  MlxDeviceStreamErrorStatus status = 1;
  string message = 2;
}

// MlxDeviceStreamErrorStatus is an internal code to set to help
// with troubleshooting and debugging.
enum MlxDeviceStreamErrorStatus {
  MLX_DEVICE_STREAM_ERROR_STATUS_INTERNAL = 0;
}

// LockStatus represents the current lock status of a device.
enum LockStatus {
  LOCK_STATUS_UNKNOWN = 0;
  LOCK_STATUS_LOCKED = 1;
  LOCK_STATUS_UNLOCKED = 2;
}

// StatusReport is a structured lockdown status report.
message StatusReport {
  // device_id is the device identifier.
  string device_id = 1;

  // status is the current lock status.
  LockStatus status = 2;

  // timestamp is when the status was checked (shoving this in RFC3339 format).
  string timestamp = 3;
}
